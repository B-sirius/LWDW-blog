---
title: ä»Devåˆ°DevOpsï¼Œå€ŸåŠ©Dockeråœ¨Azureä¸Šéƒ¨ç½²ä½ çš„ç¬¬ä¸€ä¸ªå…¨æ ˆåº”ç”¨
slug: deploy-fullstack-application-with-docker-on-azure
date: 2024-05-24
description: æœ¬åœ°åº”ç”¨å¦‚ä½•éƒ¨ç½²çº¿ä¸Šï¼Œdockerå¦‚ä½•å¸®ä½ è§£æ”¾åŒæ‰‹ï¼Œäº‘æœåŠ¡ç©¶ç«Ÿé•¿ä½œä»€æ ·ï¼Œæœ¬æ–‡å¸¦ä½ ä¸€æ¢ç©¶ç«Ÿï¼
---

## ç®€ä»‹

ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬éƒ½å·²ç»å¾ˆç†Ÿæ‚‰æœ¬åœ°å¼€å‘ç¯å¢ƒäº†ï¼Œä½†å¦‚ä½•å°†ä¸€ä¸ªæœ¬åœ°åº”ç”¨éƒ¨ç½²åˆ°çº¿ä¸Šï¼Œæˆ–è®¸è¿˜æ˜¯è§¦åŠåˆ°äº†ä½ çš„ä¸€äº›çŸ¥è¯†ç›²åŒºã€‚

![æœ¬åœ°ä¸€åˆ‡çˆ½ï¼Œçº¿ä¸Šç«è‘¬åœº](https://s2.loli.net/2024/05/16/ge3lIN4HRYBDQUL.png)

æœ¬æ–‡å°†ä¸€æ­¥æ­¥çš„å¸¦ä½ éƒ¨ç½²ä¸€ä¸ªåŒ…å«ç‹¬ç«‹å‰åç«¯çš„å®Œæ•´åº”ç”¨åˆ°**Azure**ï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©ä½ ç†è§£éƒ¨ç½²åº”ç”¨åˆ°çº¿ä¸Šçš„å¤§è‡´æ€è·¯ã€‚

æœ¬æ–‡æ‰€æ¶‰åŠçš„åº”ç”¨ä»¥åŠworkflowçš„æºä»£ç ï¼š(fullstack-demo)[https://github.com/B-sirius/fullstack-demo]

## ä¸»è§’ç™»åœº

åœ¨å¼€å§‹ä¹‹å‰ï¼Œä»‹ç»ä¸€ä¸‹æœ¬æ–‡çš„ä¸»è§’ä»¬ï¼š

- åº”ç”¨æ„æˆ
  - å‰ç«¯ï¼šReact
  - åç«¯ï¼šNodejs
  - ORMï¼šPrisma
  - æ•°æ®åº“ï¼šPostgresQL
- ä»£ç æ‰˜ç®¡ï¼šGithub
- CICDï¼šGithub Actions
- å®¹å™¨æŠ€æœ¯ï¼šDocker
- å®¹å™¨é•œåƒæ‰˜ç®¡ï¼šDocker Hub
- åå‘ä»£ç†ï¼šNginx
- äº‘æœåŠ¡ï¼šAzure
  - App Service
  - æ•°æ®åº“æœåŠ¡ï¼šAzure Database for PostgreSQL flexible server

å¥½ï¼Œåœä¸€ä¸‹ï¼Œçœ‹åˆ°è¿™é‡Œå…¶å®ä¸éš¾çœ‹å‡ºæ­¤æ¬¡æ•™ç¨‹çš„å¤§è‡´æ€è·¯ï¼Œè®©æˆ‘æ‹‰ä¸€å¼ å›¾ç»™ä½ æ„Ÿå—ä¸€ä¸‹ï¼š

![pipelineæœ€ç»ˆæ•ˆæœ](https://s2.loli.net/2024/05/16/RkLaJhfApr6giOF.png)

å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬çš„pipelineä»¥å®¹å™¨æŠ€æœ¯ä¸ºæ ¸å¿ƒï¼Œå¦‚æœä½ å¯¹dockerä¸€ç±»çš„å®¹å™¨æŠ€æœ¯è¿˜ä¸ç†Ÿæ‚‰ï¼Œå»ºè®®å…ˆå»è‡ªè¡Œäº†è§£ä¸‹ã€‚

å¦å¤–ï¼Œè¯¥æµç¨‹ç»éçº¿ä¸Šéƒ¨ç½²çš„**æœ€ä½³å®è·µ**ï¼Œåªæ˜¯æä¾›ä¸€ç§åŸºäºå®¹å™¨çš„éƒ¨ç½²æ€è·¯ï¼Œä¸”è¯¥æµç¨‹ä¹Ÿç¼ºä¹å¾ˆå¤šproductionç¯å¢ƒåº”è¯¥è€ƒè™‘çš„éƒ¨åˆ†ï¼Œè¿˜è¯·å¤§å®¶ä»…ä½œå­¦ä¹ å‚è€ƒã€‚

æœ€åï¼Œå¦‚æœä½ ä¸ç†Ÿæ‚‰ä»¥ä¸Šçš„æŸä¸ªå…·ä½“çš„æœåŠ¡ï¼Œä¹Ÿä¸è¦ç´§ï¼Œå› ä¸ºå…¶ä¸­ä»»ä½•ä¸€å—éƒ½å¯ä»¥è¢«å…¶ä»–ç±»ä¼¼çš„æœåŠ¡æ›¿ä»£ã€‚æ¯”å¦‚ï¼š

- Azure => AWS
- Docker Hub => Azure Container Registry
- Github => Gitlab

å¥½ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±å¼€å§‹ä¸€æ­¥æ­¥çš„å®ç°ä¸Šé¢çš„éƒ¨ç½²æµç¨‹ï¼

### åˆ†æä¸€ä¸‹æœ¬æ¬¡è¦éƒ¨ç½²çš„Webåº”ç”¨

åœ¨æƒ³ç€å¦‚ä½•éƒ¨ç½²çº¿ä¸Šä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¦å¯¹åº”ç”¨æœ‰ä¸€ä¸ªå¤§è‡´çš„äº†è§£ï¼š

1. ç”±å“ªäº›æœåŠ¡æ„æˆ
2. è¿™äº›æœåŠ¡åœ¨æœ¬åœ°æ˜¯å¦‚ä½•å¯åŠ¨çš„
3. ç¡®ä¿èƒ½å¤Ÿåœ¨æœ¬åœ°å°†åº”ç”¨å®Œæ•´çš„è¿è¡Œèµ·æ¥

æœ¬æ¬¡è¦éƒ¨ç½²çš„åº”ç”¨æ˜¯ä¸€ä¸ªBBSï¼Œç”¨æˆ·å¯ä»¥åœ¨ä¸Šé¢å®Œæˆå‘å¸–ï¼Œé¡¶å¸–ï¼Œè¸©è´´è¿™æ ·éå¸¸åŸºç¡€çš„åŠŸèƒ½ã€‚

è¿™ä¸ªåº”ç”¨ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š

1. Reactæ­å»ºçš„å®¢æˆ·ç«¯
2. Nodejsæ­å»ºçš„æœåŠ¡ç«¯
3. postgresæ•°æ®åº“æœåŠ¡ï¼ŒæœåŠ¡ç«¯å°†ä½¿ç”¨Prismaä¸å…¶äº¤äº’

æ˜¯éå¸¸å…¸å‹çš„å‰åç«¯åˆ†ç¦»åº”ç”¨ã€‚

### å®¢æˆ·ç«¯

æˆ‘ä»¬å…ˆçœ‹å®¢æˆ·ç«¯çš„éƒ¨åˆ†ï¼Œå®ƒæœ‰ä»¥ä¸‹ç‰¹å¾ï¼š

- ä½¿ç”¨webpackæ„å»ºçš„Reactåº”ç”¨
- æ„å»ºäº§ç‰©ä¸ºçº¯é™æ€èµ„æº

å®ƒæœ¬åœ°å¯åŠ¨çš„æ–¹å¼ï¼Œåœ¨`package.json`ä¸­å¯ä»¥çœ‹åˆ°ï¼š

```json
"start": "webpack-dev-server --mode development"
```

`webpack-dev-server`ä»åå­—å°±å¯ä»¥çœ‹å‡ºæ˜¯ç”¨äºæœ¬åœ°å¼€å‘çš„æœåŠ¡ï¼Œè™½ç„¶æˆ‘ä»¬ä¸ä¼šåœ¨çº¿ä¸Šä½¿ç”¨å®ƒï¼Œä½†æ˜¯æœ‰å¿…è¦çœ‹çœ‹å®ƒçš„ç›¸å…³é…ç½®ï¼Œäºæ˜¯æˆ‘ä»¬å°±ç‚¹å¼€äº†`webpack.config.ts`ï¼Œå¯»æ‰¾å…¶ä¸­çš„`devServer`å­—æ®µï¼š

```javascript
devServer: {
    port: 3000,
    historyApiFallback: true,
    proxy: {
      "/api": {
        target: "http://localhost:3000",
        router: () => "http://localhost:8000",
        // remove path
        pathRewrite: { "^/api": "" },
      },
    },
  }
```

è¿™é‡Œæœ‰ä¸¤ä¸ªé‡è¦ä¿¡æ¯ï¼Œåœ¨æœ¬åœ°å¼€å‘æ—¶ï¼š

1. å®¢æˆ·ç«¯åº”ç”¨ä¼šè¢«æš´éœ²åœ¨localhost:3000
2. webpackçš„åå‘ä»£ç†åŠŸèƒ½åšäº†ä¸¤ä»¶äº‹ï¼š
   1. å°†/apiæ¥æºçš„è¯·æ±‚æŒ‡å‘äº†localhost:8000
   2. é‡å†™äº†pathï¼Œè·¯å¾„ä¸­çš„`/api`éƒ¨åˆ†è¢«ç§»é™¤äº†

ä¸éš¾çŒœæµ‹ï¼Œ8000ç«¯å£æš´éœ²çš„å°±æ˜¯æˆ‘ä»¬æœ¬åœ°çš„æœåŠ¡ç«¯åº”ç”¨ã€‚

æ‰€ä»¥å®¢æˆ·ç«¯åœ¨æœ¬åœ°æ˜¯è¿™æ ·å·¥ä½œçš„ï¼š

![å®¢æˆ·ç«¯çš„è¿ä½œæ–¹å¼](https://s2.loli.net/2024/05/17/nzPAakJ6RDcHdNu.png)

### æœåŠ¡ç«¯

æœåŠ¡ç«¯æ˜¯ä¸€ä¸ªNode.jsåº”ç”¨ï¼Œæ›´å‡†å»çš„è¯´æ˜¯Nest.jsåº”ç”¨ï¼ˆä¸€ä¸ªåŸºäºNode.jsçš„æ¡†æ¶ï¼‰ï¼Œæˆ‘ä»¬çœ‹ä¸‹å®ƒåœ¨æœ¬åœ°æ˜¯å¦‚ä½•å¯åŠ¨çš„ï¼š

```JSON
"start": "nest start"
```

ä¸æ˜¯å¾ˆæœ‰è¥å…»ï¼Œæ—¢ç„¶è¿™é‡Œæ²¡æœ‰é¢å¤–çš„å‚æ•°ï¼Œé‚£æˆ‘ä»¬å°±çœ‹çœ‹Nestjsçš„å…¥å£æ–‡ä»¶`main.ts`ï¼š

```typescript
await app.listen(8000);
```

æ‰€ä»¥æœåŠ¡ç«¯æ˜¯åœ¨æœ¬åœ°8000ç«¯å£è¿è¡Œçš„ï¼Œç¬¦åˆæˆ‘ä»¬ä¸Šé¢çš„æ¨æµ‹ã€‚

### æ•°æ®åº“

æœ€åæˆ‘ä»¬çœ‹ä¸€ä¸‹æ•°æ®åº“ï¼Œæ•°æ®åº“çš„å¯åŠ¨éå¸¸ç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨`docker-compose`ä¸­çœ‹åˆ°ï¼Œè¿™é‡Œä½¿ç”¨äº†postgreså®˜æ–¹é•œåƒï¼Œå¹¶ä¼ å…¥äº†ä¸€äº›å¿…è¦çš„å‚æ•°ç”¨äºæœ¬åœ°å¯åŠ¨ã€‚å¯ä»¥çœ‹å‡ºæ•°æ®åº“æœåŠ¡å¯åŠ¨åœ¨5432ç«¯å£ã€‚

```yaml
# Postgres container
postgres:
  image: postgres:15
  restart: always
  environment:
    - POSTGRES_USER=myuser
    - POSTGRES_PASSWORD=mypassword
  volumes:
    - postgres:/var/lib/postgresql/data
  ports:
    - '5432:5432'
```

### åœ¨æœ¬åœ°å°†æ‰€æœ‰çš„æœåŠ¡è·‘èµ·æ¥

é™¤äº†ä¸Šè¿°çš„å‘½ä»¤å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é¢å¤–åšä¸¤ä»¶äº‹ï¼š

1. **è®¾ç½®ç¯å¢ƒå˜é‡`DATABASE_URL`**ï¼Œè®©æœåŠ¡ç«¯èƒ½å¤Ÿè®¿é—®æ•°æ®åº“
2. **ä½¿ç”¨Prisma Migrateæ•°æ®åº“**ï¼Œå¦åˆ™æœ¬åœ°æ•°æ®åº“å°†æ— æ³•åŒæ­¥æˆ‘ä»¬çš„æœåŠ¡ç«¯å°†è¦è®¿é—®çš„databaseï¼Œtablesç­‰ç­‰

å®Œæ•´çš„æ­¥éª¤å¯ä»¥å‚è€ƒç¤ºä¾‹ä»£ç çš„[README](https://github.com/B-sirius/fullstack-demo?tab=readme-ov-file#local-setup)ã€‚

### æ€»ç»“

æˆ‘ä»¬çš„åº”ç”¨åœ¨æœ¬åœ°æ˜¯å¦‚æ­¤è¿è¡Œçš„ï¼Œå…¶å®å¹¶ä¸å¤æ‚ï¼š

![how-client-works-full.png](https://s2.loli.net/2024/05/20/nBX6bf9zOekjELF.png)

## å°†ä¸€åˆ‡æ¬åˆ°çº¿ä¸Š

![pipelineæœ€ç»ˆæ•ˆæœ](https://s2.loli.net/2024/05/16/RkLaJhfApr6giOF.png)

è®©æˆ‘ä»¬å†æ¬¡å›é¡¾ä¸€ä¸‹è¿™å¼ å›¾ï¼Œå°†ä»£ç åŒæ­¥åˆ°Githubæƒ³å¿…ä¸ä¼šéš¾å€’ä½ ï¼Œé‚£å‰©ä¸‹è¦åšçš„äº‹æƒ…å¤§è‡´è¿˜æœ‰è¿™ä¹ˆå‡ ä»¶ï¼š

- å‡†å¤‡å„ä¸ªæœåŠ¡çš„docker image
- å‡†å¤‡workflow
  - æ„å»ºå„æœåŠ¡çš„docker imageå¹¶æ¨é€åˆ°docker hub
  - ä»docker hubæ‹‰å–imageå¹¶éƒ¨ç½²åˆ°Azure
- é…ç½®Azureç›¸å…³çš„App servicesç­‰

### 1. å‡†å¤‡docker image

è¿™éƒ¨åˆ†å°±ä¸è¿‡å¤šå™è¿°äº†ï¼Œå› ä¸ºå¦‚ä½•ä¸ºä½ çš„æœåŠ¡ç¼–å†™dockerfileå¯ä»¥è¯´æ˜¯ä¸€ä¸ªcase by caseçš„äº‹ï¼Œè¿™é‡Œå¯ä»¥å‚è€ƒæˆ‘çš„dockerfileï¼Œç›¸ä¿¡å¹¶ä¸éš¾ç†è§£ã€‚

æ€»çš„æ¥è¯´æˆ‘ä»¬åªéœ€è¦åˆ†åˆ«å‡†å¤‡å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„docker imageï¼Œè€Œçº¿ä¸Šæ•°æ®åº“æœåŠ¡æˆ‘ä»¬å°†ä¼šç›´æ¥ä½¿ç”¨Azureçš„`Azure Database for PostgreSQL flexible server`ã€‚

```dockerfile
# ä»¥clientçš„dockerfileä¸ºä¾‹

# stage 1 - build react app first
FROM node:18 AS build
WORKDIR /app
COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile
COPY . .
RUN yarn build

# stage 2 - serve the react app on nginx
FROM nginx:latest
USER root
COPY --from=build /app/build /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### 2. æ–°å¢workflowï¼Œå°†imageæ¨é€åˆ°docker hub

ç°åœ¨æˆ‘ä»¬å¼€å§‹å‡†å¤‡workflowï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆæ„å»ºdocker imageï¼Œå¹¶å°†å®ƒä»¬ä¸Šä¼ åˆ°docker hubï¼š

```yml
# ä»¥æ„å»ºå¹¶ä¸Šä¼ client imageä¸ºä¾‹

name: Build and Push Client Docker Image

on:
  push:
    branches:
      - dev
    paths:
      - "client/**" # Monitor changes in the client folder
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}
      - name: Publish Docker image to Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: "{{defaultContext}}:client" # the path where dockerfile located
          push: true
          tags: "${{ vars.CLIENT_IMAGE }}:latest"
```

è¿™é‡Œç”¨åˆ°äº†ä¸¤ä¸ªdockerå®˜æ–¹actionï¼Œå…·ä½“ä½¿ç”¨æ–¹æ³•å¯ä»¥å‚è€ƒå®ƒä»¬çš„æ–‡æ¡£

- (docker/login-action)[https://github.com/docker/login-action/tree/v3]
- (docker/build-push-action)[https://github.com/docker/build-push-action/tree/v5]

å¦‚æœworkflowå¯ä»¥æˆåŠŸè·‘èµ·æ¥ï¼Œä½ åº”è¯¥èƒ½åœ¨docker hubä¸­çœ‹è§è‡ªå·±çš„image

![docker images](https://s2.loli.net/2024/05/21/1ug4it7wcMIzXvU.png)

### 3. æ–°å¢Azureçš„æ•°æ®åº“

åœ¨ç»§ç»­è¿›è¡Œä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæŠŠçº¿ä¸Šçš„æ•°æ®åº“å‡†å¤‡å¥½ã€‚è¿™é‡Œæˆ‘é€‰ç”¨äº†Azureå®˜æ–¹çš„`Azure Database for PostgreSQL server`ã€‚éœ€è¦æ³¨æ„æ•°æ®åº“æ˜¯ä¼š**äº§ç”Ÿè´¹ç”¨çš„**ã€‚

æ•°æ®åº“åˆ›å»ºæ—¶ï¼ŒéªŒè¯æ‰‹æ®µæˆ‘é€‰ç”¨äº†ä»…PostgreSQLéªŒè¯ï¼ˆPostgreSQL authentication onlyï¼‰ï¼Œè¯·è®°ä½ä½ çš„usernameå’Œpasswordã€‚

åœ¨åˆ›å»ºæˆåŠŸåï¼Œä½ çš„æ•°æ®åº“åº”è¯¥æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„Server Nameä¸ºï¼š`<your-database-name>.postgres.database.azure.com`ã€‚

![postgreSQL serviec](https://s2.loli.net/2024/05/21/eQ3cCwyqozVYPXK.png)

å¦å¤–ä½ åº”è¯¥å»`Networking`ä¸­ä¸ºæ•°æ®åº“è®¾ç½®é˜²ç«å¢™è§„åˆ™ï¼Œä»…å…è®¸ä½ å½“å‰çš„å®¢æˆ·ç«¯ipè®¿é—®ã€‚

![firewall rule](https://s2.loli.net/2024/05/21/HwMEkDC6r75eG9o.png)

æ•°æ®åº“å‡†å¤‡å¥½åï¼Œä½ å¯ä»¥å°è¯•ç”¨pgAdminä¸€ç±»çš„å·¥å…·å»è¿æ¥å®ƒï¼Œç¡®ä¿é…ç½®æ²¡æœ‰é—®é¢˜ã€‚

### 4. é…ç½®Azureçš„App Services

æ•°æ®åº“å‡†å¤‡å¥½åã€‚è®©æˆ‘ä»¬åˆ†åˆ«ä¸ºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åˆ›å»ºApp Servicesã€‚å¦‚ä½•åˆ›å»ºä¸€ä¸ªApp Serviceè¿™é‡Œä¹Ÿä¸åšèµ˜è¿°ï¼Œæ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

- åˆ›å»ºä¸€ä¸ª`Web App`
- å¯ä»¥å…ˆéšä¾¿éƒ¨ç½²ä¸€ä¸ªé»˜è®¤é•œåƒï¼ˆæ¯”å¦‚Nginxï¼‰

æ¯ä¸ªapp serviceéƒ½ä¼šæœ‰ä¸€ä¸ª`default domain`ï¼Œæ ¼å¼ä¸º`<your-web-app-name>.azurewebsites.net`ï¼Œè¿™ä¸ªåœ°å€é»˜è®¤æ˜¯å¯ä»¥åœ¨å…¬ç½‘è®¿é—®çš„ã€‚æˆ‘ç°åœ¨åˆ†åˆ«ä¸ºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åˆ›å»ºäº†app serviceï¼š

![app services](https://s2.loli.net/2024/05/21/Ya7ORDTrQgMijAP.png)

### 5. è®¾ç½®å¿…è¦çš„ç¯å¢ƒå˜é‡

è¿˜è®°å¾—æˆ‘ä»¬åœ¨æœ¬åœ°å¯åŠ¨æœåŠ¡ç«¯åº”ç”¨çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯ç”¨åˆ°äº†ä¸€ä¸ªç¯å¢ƒå˜é‡ä¹ˆ`DATABASE_URL`ï¼Ÿè¿™ä¸ªç¯å¢ƒå˜é‡å‘Šè¯‰æœåŠ¡ç«¯ï¼ŒPrismaå¦‚ä½•è¿æ¥æ•°æ®åº“ã€‚åœ¨æœ¬åœ°çš„æ—¶å€™ï¼Œç¯å¢ƒå˜é‡çš„å€¼æ˜¯ï¼š

```
DATABASE_URL="postgresql://myuser:mypassword@localhost:5432/mydb?schema=public"
```

è¿™ä¸ªå€¼çš„ç»“æ„æ˜¯ï¼š`postgresql://<username>:<password>@<server-domain>:<server-port>/<database-name>?schema=public`

å‡è®¾æˆ‘ä»¬çš„Azure Databaseçš„ä¿¡æ¯æ˜¯è¿™æ ·ï¼š

- Server Nameï¼štest.postgres.database.azure.com
- è´¦å·ï¼štestuser
- å¯†ç ï¼šHolyPostgres9876

é‚£çº¿ä¸Šçš„`DATABASE_URL`å°±æ˜¯`postgresql://testuser:HolyPostgres9876@test.postgres.database.azure.com:5432/mydb?schema=public`

é‚£ä¹ˆåœ¨å“ªé‡Œè®¾ç½®è¿™ä¸ªå€¼å‘¢ï¼Ÿç”±äºè¿™ä¸ªå€¼ç°åœ¨æ˜¯æœåŠ¡ç«¯çš„App Serviceè¿è¡Œcontaineræ‰€éœ€è¦çš„ï¼Œæˆ‘ä»¬åº”è¯¥å»å¯¹åº”çš„App Serviceçš„`Environment variables`å»è®¾ç½®å®ƒï¼š

![Environment variables](https://s2.loli.net/2024/05/22/BnUcxqrh2WYOXNT.png)

### 6. æ–°å¢workflowï¼Œè®©Azureæ‹‰å–æˆ‘ä»¬çš„docker imageå¹¶è¿›è¡Œéƒ¨ç½²

```yml
# ä»¥éƒ¨ç½²client imageä¸ºä¾‹

name: Deploy Client Image to Azure App Service

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v2
        with:
          app-name: "test-fullstack-client"
          slot-name: "production"
          publish-profile: ${{ secrets.AZURE_CLIENT_PUBLISH_PROFILE }}
          images: "index.docker.io/${{ vars.CLIENT_IMAGE }}:latest"
```

è¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ªAzureçš„å®˜æ–¹actionï¼š(Azure/webapps-deploy)[https://github.com/Azure/webapps-deploy/tree/v2]ï¼Œå¯ä»¥ç›´æ¥æŠŠå¯¹åº”çš„imageéƒ¨ç½²åˆ°ä½ æŒ‡å®šçš„azure app serviceã€‚

è¯•ç€è¿è¡Œä¸‹ä½ çš„workflowï¼Œå¦‚æœæˆåŠŸçš„è¯ï¼Œåˆ·æ–°Azureåä½ åº”è¯¥èƒ½çœ‹åˆ°`Container Image`å˜ä¸ºäº†ä½ è‡ªå·±çš„Imageï¼š

![container image updated](https://s2.loli.net/2024/05/21/8swD7kLSUcWhqu4.png)

### 7. Migrate Azureæ•°æ®åº“

å¯¹äºçº¿ä¸Šæ•°æ®åº“ï¼Œæˆ‘ä»¬åŒæ ·ä¹Ÿéœ€è¦Migrateã€‚

åœ¨æœ¬åœ°è¿è¡Œé¡¹ç›®çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿è¡Œäº†`yarn migrate`ï¼Œå®ƒå®é™…ä¸Šè°ƒç”¨äº†`npx prisma migrate dev`ï¼Œprismaä¼šè¯»å–æœ¬åœ°çš„`.env`ï¼Œè¿æ¥åˆ°æœ¬åœ°æ•°æ®åº“ï¼Œå¹¶è¿›è¡Œmigrateã€‚

å°½ç®¡æˆ‘ä»¬è¿™ä¸èƒ½ç®—ä¸€ä¸ªproductionæ¡ˆä¾‹ï¼Œä½†æ€»çš„æ¥è¯´è¿˜æ˜¯ä¸æ¨èä½¿ç”¨è¿™ç§æ–¹å¼å»æ“ä½œçº¿ä¸Šæ•°æ®åº“ã€‚å› æ­¤ä¾ç…§[Prismaæ–‡æ¡£](https://www.prisma.io/docs/orm/prisma-client/deployment/deploy-database-changes-with-prisma-migrate)çš„å»ºè®®ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Deploy Service Imageçš„æ—¶å€™å»Migrateçº¿ä¸Šæ•°æ®åº“ï¼š

```yml
name: Deploy Server Image to Azure App Service

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev

    steps:

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Dependencies
        working-directory: ./server
        run: yarn

			# é‡ç‚¹åœ¨è¿™é‡Œï¼
      - name: Apply all pending migrations to the database
        working-directory: ./server
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v2
        with:
          app-name: "test-fullstack-server"
          slot-name: "production"
          publish-profile: ${{ secrets.AZURE_SERVER_PUBLISH_PROFILE }}
          images: "index.docker.io/${{ vars.SERVER_IMAGE }}:latest"

```

ç°åœ¨æˆ‘ä»¬åœ¨éƒ¨ç½²æœåŠ¡ç«¯é•œåƒæ—¶ï¼Œæ•°æ®åº“ç»“æ„ä¹Ÿèƒ½ä¿æŒæ›´æ–°ã€‚

### 8. éªŒè¯å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„çŠ¶æ€

æ­¤æ—¶æˆ‘ä»¬å¯ä»¥åˆ†åˆ«è®¿é—®å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é»˜è®¤åŸŸåã€‚

å®¢æˆ·ç«¯åŸŸåæ­¤æ—¶åº”è¯¥å¯ä»¥åŠ è½½å‡ºé¡µé¢ï¼Œå°½ç®¡è¯·æ±‚éƒ½404â€”â€”éå¸¸åˆç†ï¼Œå› ä¸ºè¯·æ±‚ç›®å‰éƒ½æ²¡æœ‰å‘½ä¸­åˆ°åç«¯æœåŠ¡ï¼š

![request 404](https://s2.loli.net/2024/05/22/TmcA8yVxHfqoUgG.png)

è€ŒæœåŠ¡ç«¯åŸŸåæ­¤æ—¶åº”è¯¥å¯ä»¥è¿”å›ä¸€äº›æ¥å£å“åº”äº†ï¼š

![server](https://s2.loli.net/2024/05/22/RQmLkVydwxEOoez.png)

### 9. é…ç½®Nginx

åœ¨æœ¬åœ°å¼€å‘æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Webpack Dev Serveræä¾›çš„proxyèƒ½åŠ›ï¼Œè¿æ¥èµ·äº†å‰åç«¯ã€‚èƒ½å¤Ÿåšåˆ°ç±»ä¼¼äº‹æƒ…çš„å¸¸è§æœåŠ¡è¿˜æœ‰ä¸€ä¸ªï¼Œé‚£å°±æ˜¯Nginxï¼

é‚£ä¹ˆå¦‚ä½•åœ¨çº¿ä¸Šè¿è¡Œè¿™æ ·ä¸€ä¸ªNginxæœåŠ¡ï¼Ÿèªæ˜çš„ä½ ä¸€å®šæƒ³åˆ°äº†ï¼Œå†æ‰“ä¸€ä¸ªé•œåƒä¸å°±è¡Œäº†ï¼

æˆ‘ä»¬å…ˆä¾è‘«èŠ¦ç”»ç“¢æ–°å»ºä¸€ä¸ªApp Serviceä¾›Nginxä½¿ç”¨ï¼ŒDefault Domainä¸º`test-fullstack.azurewebsites.net`

ç„¶ååœ¨ä»£ç æ–°å»ºä¸€ä¸ªnginxé…ç½®æ–‡ä»¶ï¼š

```nginx
# nginx.conf

events {}
http {
  server {
    server_name <your-nginx-app-service-name>.azurewebsites.net;

    location / {
      proxy_pass <your-client-app-service-name>.azurewebsites.net;
    }
    location /api {
      rewrite /api/(.*) /$1  break;
      proxy_pass <your-server-app-service-name>.azurewebsites.net;
    }
  }
}
```

ä¸€ç›®äº†ç„¶ï¼Œæˆ‘ä»¬çš„nginxæœåŠ¡ä¼šåˆ†åˆ«å°†è·¯ç”±æŒ‡å‘å¯¹åº”çš„æœåŠ¡ï¼Œå’Œwebpack-dev-serverçš„proxyä½œç”¨å‡ ä¹ä¸€æ¨¡ä¸€æ ·ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬åªè¦ä»¿ç…§å‰é¢çš„æ­¥éª¤å»å°†è¿™ä¸ªé•œåƒæ„å»ºå¹¶æ¨é€åˆ°docker hubï¼Œå¹¶è¿›è¡Œéƒ¨ç½²ã€‚

è¿™ä¸€æ­¥å®Œæˆåï¼Œç›´æ¥è®¿é—®ä½ çš„Nginxçš„Default Domainï¼Œæˆ‘ä»¬çš„æœåŠ¡åº”è¯¥å°±å¯ä»¥æ­£å¸¸åœ¨çº¿ä¸Šè¿è¡Œäº†ï¼

![çº¿ä¸ŠæˆåŠŸè¿è¡Œ](https://s2.loli.net/2024/05/24/fGhBPDpskeIX3jC.png)

### 10. çº¿ä¸Šæ¶æ„

ç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªåº”ç”¨çš„çº¿ä¸Šæ¶æ„ï¼Œå…¶å®éå¸¸ç®€å•ï¼Œè€Œä¸”ä¸æœ¬åœ°æœåŠ¡ç»“æ„ç±»ä¼¼ï¼š

![å®¢æˆ·ç«¯çº¿ä¸Šæ¶æ„](https://s2.loli.net/2024/05/24/QvESPtTRUKLAbdh.png)

## æ€»ç»“&æå‡

æœ¬æ–‡çš„æ–¹æ¡ˆéå¸¸çš„å•çº¯ï¼Œæ ¸å¿ƒå°±æ˜¯æŠŠæœ¬åœ°åº”ç”¨éƒ½åˆ†åˆ«é•œåƒåŒ–ï¼Œç„¶åéƒ¨ç½²åˆ°çº¿ä¸Šè€Œå·²ã€‚ä½†æˆ‘ä»¬ç›®å‰çš„åº”ç”¨æœ‰ä¸€ä¸ªæ˜¾ç„¶çš„é—®é¢˜ï¼šå®¢æˆ·ç«¯æœåŠ¡çš„åŸŸåå’ŒæœåŠ¡ç«¯æœåŠ¡çš„åŸŸåéƒ½æ˜¯å¯ä»¥åœ¨å…¬ç½‘è¢«è®¿é—®çš„ï¼è€ƒè™‘åˆ°æˆ‘ä»¬å¸Œæœ›ä½¿ç”¨NginxæœåŠ¡ä½œä¸ºå…¬ç½‘æµé‡çš„å…¥å£ï¼Œå°†å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„åŸŸåé™åˆ¶åœ¨å†…ç½‘æ‰æ›´ä¸ºåˆç†ã€‚

è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥è¯·å‡ºä¸¤ä¸ªå…³é”®çš„æœåŠ¡ï¼š

- Applicatoin Gateway
- Virtual networks

é€šè¿‡å°†å‰åç«¯æœåŠ¡é™åˆ¶åœ¨Virtual Networksä¸­ï¼Œå¹¶é€šè¿‡Application Gatewayè®¿é—®ï¼Œå¯ä»¥è®©æˆ‘ä»¬çš„æœåŠ¡æ›´åŠ å®‰å…¨ã€‚è€Œä¸”æ˜¾ç„¶Application Gatewayè¿˜æä¾›äº†è®¸å¤šå…¶ä»–åŠŸèƒ½ï¼ˆè´Ÿè½½å‡è¡¡ã€è‡ªåŠ¨æ‰©å®¹ç­‰ç­‰ï¼‰ã€‚åªä¸è¿‡å®ƒæœ‰ç‚¹è´µï¼Œæˆ‘å°è¯•äº†ä¸€ä¸‹ä¸€å¤©å°†è¿‘50å—ï¼ˆè´§å¸å•ä½ä¸ºæ—¥å…ƒï¼‰ï¼š

![åº”ç”¨ç½‘å…³è´¹ç”¨](https://s2.loli.net/2024/05/22/AjYx8kU7aGHMemf.png)

ä½†å¦‚æœä½ å¯¹è¿™éƒ¨åˆ†å†…å®¹æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹çœ‹è¿™ä¸ªæ²¹ç®¡è§†é¢‘ï¼š[App Service Application Gateway Configuration](https://www.youtube.com/watch?v=1HG_TKG468w)ã€‚

æœ€åï¼Œæœ¬æ–‡ä½œè€…åœ¨äº‘æœåŠ¡æ–¹é¢å®Œå®Œå…¨å…¨æ˜¯ä¸ªæ–°æ‰‹ï¼Œå¦‚æœä½ é˜…è¯»æœ¬æ–‡åå‘ç°æœ‰é”™è¯¯æˆ–è€…å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ï¼Œæ¬¢è¿æŒ‡æ­£ï¼Œæ„Ÿè°¢ğŸ™
